两段锁和封锁粒度
==================
##封锁协议
在运用封锁方法时，对数据对象加锁时需要约定一些规则，例如何时申请封锁、持锁时间、何时释放封锁等。这些规则就是封锁协议。
##两段锁协议
DBMS普遍采用两段锁（Two-Phase Locking，简称2PL）协议的方法实现并发调度的可串行性。  

两段锁协议是指所有事务必须分为两个阶段：
- 获得封锁（扩展阶段）：在这阶段，事务可以申请获得任何数据项上的任何锁的类型，但是不能释放任何锁。
- 释放封锁（收缩阶段）：在这阶段，事务可以释放任何数据项上的任何类型的锁，但是不能再申请任何锁。
```
事务遵守**两段锁协议**是可串行化调度的**充分条件**，而不是必要条件。
```
>两段锁协议与防止死锁的一次封锁法的异同之处：一次封锁法遵守两段锁协议，但是两段锁协议并不要求事务必须一次性将所有要使用的数据全部加锁，因此遵守二段锁协议的事务可能发生死锁。

##封锁的粒度
**封锁对象的大小称为封锁粒度**。  

封锁的单元可以是逻辑单元（属性值、属性值集合、元组、关系、索引项、整个索引直至整个数据库），也可以是物理单元（
数据页或索引页、物理记录）。
###多粒度封锁
如果在一个系统中同时支持多种封锁粒度供不同的事务选择是比较理想的，这种封锁方法称为多粒度封锁。  

>####多粒度树
多粒度树的根结点表示整个数据库，封锁粒度最大；叶结点的封锁粒度最小。  
比如：三级粒度树的根结点为数据库，数据库的子结点为关系，关系的子结点为元组。  
又如：四级粒度树的的组成为：数据库、数据库分区、数据文件、数据记录

多粒度封锁协议允许多粒度树中每个结点被独立地加锁。因此多粒度封锁中的数据对象可能以两种方式封锁。

|两种方式|定义|
|----|----
|显式封锁|应事务要求直接加到数据对象上的封锁
|隐式封锁|改数据对象没有被独立加锁，是由于其上级结点加锁而使该数据对象加了锁

###意向锁
意向锁的含义是如果对一个结点加意向锁，则说明该结点的下层结点正在被加锁；对任一结点加锁时，必须先对它的上一层结点加意向锁。

三种常用的意向锁：

|意向锁类型|缩写|定义|
|:----:|:----:|----
|意向共享锁|IS|如果对一个数据对象加IS锁，表示它的后裔结点拟加S锁
|意向排它锁|IX|如果对一个数据对象加IX锁，表示它的后裔结点拟加X锁
|共享意向排它锁|SIX|如果对一个数据对象加SIX锁，表示对它加S锁，再加IX锁

